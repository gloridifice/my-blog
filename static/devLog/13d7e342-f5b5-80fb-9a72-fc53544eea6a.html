<!DOCTYPE html><html>
  <head lang="zh_CN">
    <meta http-equiv="Content-Type" content="charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/assets/js/header.js"></script>
    <script src="/assets/katex/katex.js"></script>
<script defer src="/assets/katex/auto-render.min.js" onload="renderMathInElement(document.body);"></script>    <script>document.addEventListener(&quot;DOMContentLoaded&quot;, function() {
    renderMathInElement(document.body, {
      delimiters: [
          {left: '$$', right: '$$', display: false},
      ],
      throwOnError : false
    });
});</script>
    <link rel="stylesheet" href="/assets/katex/katex.css">
    <link rel="stylesheet" href="/assets/css/reset.css">
    <link rel="stylesheet" href="/assets/css/root.css">
    <link rel="stylesheet" href="/assets/css/color_scheme_v2.dark_mode.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;600;700&amp;display=swap" rel="stylesheet">
    <script src="/assets/js/highlightjs/highlight.js"></script>
    <link rel="stylesheet" href="/assets/css/layout.css">
    <link rel="stylesheet" href="/assets/css/page_content.css">
    <link rel="stylesheet" href="/assets/css/post.css">
    <link rel="stylesheet" href="/assets/css/color_scheme_v2.dark_mode.css">
    <link rel="stylesheet" href="/assets/css/highlightjs/github-dark.css">
    <title>ğŸ¦† æ¸²æŸ“ç®¡çº¿ã€Depthã€Cameraã€Lightã€Transformã€bevy_ecsï½œWgpu PBR å¼€å‘æ—¥å¿— #0000</title>
  </head>
  <body>
    <script>hljs.highlightAll();</script>
    <div class="post">
      <div class="catalogue">
        <div>
          <ul>
            <li class="h1"><a href="#heading1_0">
                <t>Mesh</t>
              </a></li>
            <li class="h2"><a href="#heading2_0">
                <t>æ¨¡å‹çš„æ•°æ®ç»“æ„</t>
              </a></li>
            <li class="h1"><a href="#heading1_1">
                <t>Material</t>
              </a></li>
            <li class="h1"><a href="#heading1_2">
                <t>Texture</t>
              </a></li>
            <li class="h1"><a href="#heading1_3">
                <t>å®ç° Camera</t>
              </a></li>
            <li class="h2"><a href="#heading2_0">
                <t>RenderCamera</t>
              </a></li>
            <li class="h1"><a href="#heading1_4">
                <t>å®ç° Transform</t>
              </a></li>
            <li class="h2"><a href="#heading2_0">
                <t>æ•°æ®å¤§å°å¯¹é½</t>
              </a></li>
            <li class="h2"><a href="#heading2_0">
                <t>å°è£…</t>
              </a></li>
            <li class="h1"><a href="#heading1_5">
                <t>å®ç°å¹³è¡Œå…‰</t>
              </a></li>
            <li class="h1"><a href="#heading1_6">
                <t>Engine Lifetime</t>
              </a></li>
            <li class="h1"><a href="#heading1_7">
                <t>å…¶å®ƒ</t>
              </a></li>
            <li class="h1"><a href="#heading1_8">
                <t>ç›¸å…³é“¾æ¥</t>
              </a></li>
          </ul>
        </div>
      </div>
      <div class="navi"><a class="navi_link" href="/home.html">ä¸»é¡µ</a><a class="navi_link" href="/blogs.html">åšå®¢</a><a class="navi_link" href="/portfolio.html">é¡¹ç›®</a><a class="navi_link" href="/about.html">å…³äº</a></div>
      <div class="sidebar_wrapper_left sidebar_wrapper"></div>
      <div class="sidebar_wrapper_right sidebar_wrapper"></div>
      <div class="contents">
        <div class="header"><a class="navi_link" href="/home.html">ä¸»é¡µ</a><a class="navi_link" href="/blogs.html">åšå®¢</a><a class="navi_link" href="/portfolio.html">é¡¹ç›®</a><a class="navi_link" href="/about.html">å…³äº</a></div>
        <div class="page_description">
          <h1 class="title">ğŸ¦† æ¸²æŸ“ç®¡çº¿ã€Depthã€Cameraã€Lightã€Transformã€bevy_ecsï½œWgpu PBR å¼€å‘æ—¥å¿— #0000</h1>
          <div class="sub_info">
            <p class="date">2025-01-02</p>
          </div>
        </div>
        <div class="page_content">
          <div class="image_wrapper"><img src="/devLog/13d7e342-f5b5-80fb-9a72-fc53544eea6a/img_13d7e342-f5b5-809c-80ac-c2531f82e3f7.gif">
            <div class="caption"></div>
          </div>
          <p>
            <t>Wgpu PBR æ˜¯ä¸€ä¸ªæ—¨åœ¨ç”¨ wgpu å’Œ rust å»ºç«‹ä¸€ä¸ª PBR æ¸²æŸ“ç®¡çº¿æ¸²æŸ“å™¨çš„ç»ƒä¹ é¡¹ç›®ã€‚æœªæ¥å¯èƒ½ä¼šå®ç°å„ç§å…¶å®ƒçš„å›¾å½¢å­¦æ•ˆæœã€‚</t>
          </p>
          <p>
            <t>å…¶ç›®å‰ä½¿ç”¨ Egui ä½œä¸º UIï¼Œbevy_ecs åº“ç®¡ç†é€»è¾‘ã€‚</t>
          </p>
          <blockquote>
            <t>ç°é˜¶æ®µå±•ç¤ºå‡ºçš„ä»£ç ä¸ºæ—©æœŸå¼€å‘ç‰ˆæœ¬ï¼Œæœªæ¥å¤§æ¦‚ç‡éƒ½ä¼šè¢«é‡æ„</t>
          </blockquote>
          <h1 id="heading1_0">
            <t>Mesh</t>
          </h1>
          <p>
            <t>åŠ è½½å¥½çš„æ¨¡å‹æ˜¯å¦‚ä¸‹çš„åŒ…å«å…³ç³»ï¼š</t>
          </p>
          <p>
            <t>Model â†’ Mesh â†’ Primitive.</t>
          </p>
          <p>
            <t>Primitive è™½ç„¶æ˜¯æ¨¡å‹çš„æœ€å°å•ä½ï¼Œä½†æ˜¯ä¸èƒ½è¢«å•ç‹¬æ¸²æŸ“ï¼Œåªèƒ½åœ¨ä¸€ä¸ª Mesh è¢«æ¸²æŸ“æ—¶è¢«æ¸²æŸ“ã€‚Primitive æ˜¯ä¹Ÿæ‰¿è½½æè´¨çš„å•ä½ã€‚</t>
          </p>
          <h2 id="heading2_0">
            <t>æ¨¡å‹çš„æ•°æ®ç»“æ„</t>
          </h2>
          <ul>
            <li>
              <t>Model</t>
              <ul>
                <li>
                  <t>UploadedMesh (Vec&lt;_&gt;)</t>
                  <ul>
                    <li>
                      <t>Vertex buffer</t>
                    </li>
                  </ul>
                  <ul>
                    <li>
                      <t>Index buffer</t>
                    </li>
                  </ul>
                  <ul>
                    <li>
                      <t>UploadedPrimitive (Vec&lt;_&gt;)</t>
                      <ul>
                        <li>
                          <t>indices_start</t>
                        </li>
                      </ul>
                      <ul>
                        <li>
                          <t>indices_num</t>
                        </li>
                      </ul>
                      <ul>
                        <li>
                          <t>material_instance</t>
                        </li>
                      </ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
          <p>
            <t>ç›®å‰æ”¯æŒåŠ è½½ glb æ ¼å¼çš„æ¨¡å‹ã€‚</t>
          </p>
          <h1 id="heading1_1">
            <t>Material</t>
          </h1>
          <p>
            <t>Material çš„ç¼–ç¨‹èŒƒå¼æœ¬è´¨æ˜¯ç»„ç»‡å’Œç®¡ç† Pipeline å’Œ BindGroupï¼ˆåŒæ—¶è¿˜å­˜å‚¨ç›¸å…³çš„ Layoutï¼‰ã€‚ç›®å‰é¡¹ç›®çš„æè´¨çš„ BindGroupLayout å¦‚ä¸‹ï¼š</t>
          </p>
          <ol>
            <li>
              <t>Transform</t>
            </li>
          </ol>
          <ol>
            <li>
              <t>Camera</t>
            </li>
          </ol>
          <ol>
            <li>
              <t>Light</t>
            </li>
          </ol>
          <ol>
            <li>
              <t>[Materialâ€˜s]</t>
              <ol>
                <li>
                  <t>Texture</t>
                </li>
              </ol>
            </li>
          </ol>
          <p>
            <t>Material èŒƒå¼åœ¨è¿™ä¸ªé¡¹ç›®ç›®å‰æ˜¯ç”¨ Material å’Œ Material Instance ä¸¤ä¸ªç»“æ„ä½“æ¥å®ç°çš„ã€‚</t>
          </p>
          <p>
            <t>ä¸€ä¸ª Material æä¾› </t>
            <t class="code">Pipeline</t>
            <t> å’Œé€šç”¨çš„ </t>
            <t class="code">BindGroup</t>
            <t> ï¼ˆå¦‚ Camera, Lightï¼‰å’Œå®šä¹‰åŠå­˜å‚¨ç›¸å…³çš„ </t>
            <t class="code">Layout</t>
            <t>ï¼Œè€Œ Instance åˆ™æä¾› Instance ä¹‹é—´ä¼šæœ‰å·®å¼‚çš„ </t>
            <t class="code">BindGroup</t>
            <t> ï¼ˆå¦‚ Textureï¼‰ã€‚</t>
          </p>
          <ul>
            <li>
              <t>Transform çš„ </t>
              <t class="code">BindGroup</t>
              <t> ç”± </t>
              <t class="code">MeshRenderer</t>
              <t> æä¾›ã€‚</t>
            </li>
          </ul>
          <h1 id="heading1_2">
            <t>Texture</t>
          </h1>
          <p>
            <t>å¯è§ </t>
            <t class="href" onclick="window.open('https://sotrh.github.io/learn-wgpu/beginner/tutorial5-textures/')">https://sotrh.github.io/learn-wgpu/beginner/tutorial5-textures/</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">pub struct UploadedImage {
    pub size: wgpu::Extent3d,
    pub texture: Texture,
    pub view: TextureView,
    pub sampler: Sampler,
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <h1 id="heading1_3">
            <t>å®ç° Camera</t>
          </h1>
          <p>
            <t>æ•°å­¦åº“ä½¿ç”¨ cgmathï¼ŒCamera çš„ View çŸ©é˜µ Projection çŸ©é˜µå¯ä»¥ç”¨ cgmath å¿«é€Ÿè®¡ç®—ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">impl Camera{
    ...
    pub fn build_view_projection_matrix(&amp;self) -&gt; Matrix4&lt;f32&gt; {
        let view = Matrix4::look_at_rh(self.eye, self.target, self.up);
        let proj = perspective(cgmath::Deg(self.fovy), self.aspect, self.znear, self.zfar);
        return OPENGL_TO_WGPU_MATRIX * proj * view;
    }
}

#[rustfmt::skip]
pub const OPENGL_TO_WGPU_MATRIX: cgmath::Matrix4&lt;f32&gt; = cgmath::Matrix4::new(
    1.0, 0.0, 0.0, 0.0,
    0.0, 1.0, 0.0, 0.0,
    0.0, 0.0, 0.5, 0.5,
    0.0, 0.0, 0.0, 1.0,
);</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <p>
            <t>å› ä¸º OpenGL ä¸­æ ‡å‡†åŒ–è®¾å¤‡åæ ‡ï¼ˆNDCï¼‰çš„æ·±åº¦èŒƒå›´ (z) ä¸º [-1, 1]ï¼Œè€Œ wpgu/Vulkan/DX/Mental ä¸­çš„æ ‡å‡†åŒ–è®¾å¤‡åæ ‡çš„æ·±åº¦èŒƒå›´ä¸º [0, 1]ï¼Œcgmath ç”Ÿæˆçš„æŠ•å½±çŸ©é˜µç¬¦åˆ OpenGL è§„èŒƒï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªè½¬æ¢çŸ©é˜µå°†æ·±åº¦æ˜ å°„åˆ° [0, 1]ã€‚</t>
          </p>
          <h2 id="heading2_1">
            <t>RenderCamera</t>
          </h2>
          <p>
            <t>ç›¸æœºç›¸å…³çš„ Buffer, BindGroupLayout, BindGroup å­˜æ”¾åœ¨ </t>
            <t class="code">RenderCamera</t>
            <t> çš„ bevy ä¸­çš„ Resource ç®¡ç†ã€‚åœ¨ RenderCamera åˆå§‹åŒ–æ—¶ä¸€èµ·ç”Ÿæˆã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">#[derive(Resource)]
pub struct RenderCamera {
    pub camera: Camera,
    pub buffer: Arc&lt;wgpu::Buffer&gt;,
    pub bind_group_layout: Arc&lt;BindGroupLayout&gt;,
    pub bind_group: Arc&lt;BindGroup&gt;,
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">impl RenderCamera {
    pub fn new(device: &amp;wgpu::Device, aspect: f32) -&gt; RenderCamera {
        let camera = Camera::new(aspect);
        let camera_buffer = device.create_buffer_init(&amp;wgpu::util::BufferInitDescriptor {
          ...
        });
        let camera_bind_group_layout =
            Arc::new(device.create_bind_group_layout(&amp;CameraUniform::layout_desc()));
        let camera_bind_group = Arc::new(device.create_bind_group(&amp;wgpu::BindGroupDescriptor {
          ...
        }));
        RenderCamera {
            camera,
            buffer: Arc::new(camera_buffer),
            bind_group_layout: camera_bind_group_layout,
            bind_group: camera_bind_group,
        }
    }
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <h1 id="heading1_4">
            <t>å®ç° Transform</t>
          </h1>
          <blockquote>
            <t>ä»…ä¸ºå®ç°æ–¹ä¾¿æ‰è¿™æ ·å®ç°ï¼Œä¸å€¼å¾—å‚è€ƒï¼Œå¯»æ‰¾å‚è€ƒè¯·è§ Bevy çš„ Transform é€»è¾‘å®ç°</t>
          </blockquote>
          <p>
            <t>é€»è¾‘ä¸Šçš„ Transform å¦‚ä¸‹ï¼š</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">#[derive(Component)]
pub struct Transform {
    pub parent: Option&lt;Entity&gt;,
    pub children: Vec&lt;Entity&gt;,
    pub position: Point3&lt;f32&gt;,
    pub rotation: Quaternion&lt;f32&gt;,
    pub scale: Vector3&lt;f32&gt;,
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <p>
            <t>æ¸²æŸ“ä¸Šï¼Œç›®å‰ Transform ç”¨ uniform å®ç°ã€‚è¢«ä¼ é€’åˆ° GPU çš„ Uniform Buffer åŒ…å«ä¸€ä¸ªæ¨¡å‹çŸ©é˜µï¼ˆç”¨äºå˜æ¢é¡¶ç‚¹ä½ç½®ï¼‰å’Œä¸€ä¸ªæ¨¡å‹çš„æ—‹è½¬çŸ©é˜µï¼ˆç”¨äºå˜æ¢é¡¶ç‚¹æ³•çº¿ï¼‰ã€‚</t>
          </p>
          <h2 id="heading2_2">
            <t>æ•°æ®å¤§å°å¯¹é½</t>
          </h2>
          <p>
            <t>å°†æ•°æ®ä¼ é€’åˆ° gpu éœ€è¦å¯¹å…¶å¤§å° alignmentï¼Œ éµå¾ªæ ‡å‡†å¸ƒå±€è§„åˆ™ (std140 æˆ– std430)ã€‚åœ¨ wgsl ä¸­ï¼Œå…¶å¤§å°è¢«è§†ä¸ºå¦‚ä¸‹ï¼Œç”¨æ£•è‰²æ ‡æ³¨äº†ç±»å‹å¤§å°ä¸ rust ä¸­ä¸åŒçš„æƒ…å†µï¼š</t>
          </p>
          <div class="table">
            <table>
              <tr class="table_header">
                <td>æ•°æ®ç±»å‹ &lt;f32&gt;</td>
                <td>f32</td>
                <td>vec2</td>
                <td>vec3</td>
                <td>vec4</td>
                <td>mat3x3</td>
                <td>mat4x4</td>
              </tr>
              <tr>
                <td>å¤§å° / å­—èŠ‚</td>
                <td>4</td>
                <td>8</td>
                <td>16</td>
                <td>16</td>
                <td>48 (3 * vec3)</td>
                <td>64 (4 * vec3)</td>
              </tr>
            </table>
          </div>
          <p>
            <t>æ­¤å¤–ï¼Œä¼ å…¥ Buffer çš„å¤§å°å¿…é¡»æ—¶ 16 çš„å€æ•°ã€‚å› æ­¤å£°æ˜ padding å˜é‡å¯¹å…¶æ•°æ®ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">pub struct TransformUniform {
    pub model: [[f32; 4]; 4],
    pub rotation: [[f32; 3]; 3],
    pub padding: [f32; 3],
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <h2 id="heading2_3">
            <t>å°è£…</t>
          </h2>
          <p>
            <t>æ¯ä¸ªæœ‰ Transform çš„è¦è¢«æ¸²æŸ“çš„æ¨¡å‹ï¼Œéƒ½æœ‰ç‹¬ç«‹çš„ Transform Buffer å’Œ BindGroupï¼Œæ‰€ä»¥å®ƒä»¬è¢«ä¸€èµ·å°è£…åˆ°äº†ä¸€ä¸ªå« </t>
            <t class="code">MeshRenderer</t>
            <t> çš„ç»„ä»¶ä¸­ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">#[derive(Component, Default)]
pub struct MeshRenderer {
    pub mesh: Option&lt;Arc&lt;UploadedMesh&gt;&gt;,
    pub transform_bind_group: Option&lt;Arc&lt;BindGroup&gt;&gt;,
    pub transform_buffer: Option&lt;Arc&lt;Buffer&gt;&gt;,
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <h1 id="heading1_5">
            <t>å®ç°å¹³è¡Œå…‰</t>
          </h1>
          <p>
            <t>ä¸ Camera çš„å®ç°ç±»ä¼¼ï¼Œé‡‡ç”¨ä¸€ä¸ª RenderLight ç®¡ç†ã€‚ç›®å‰åªåŒ…å«ä¸€ä¸ªå¹³è¡Œå…‰ã€‚</t>
          </p>
          <p>
            <t>ä¼ å…¥ GPU çš„ LightUniform ç»“æ„å¦‚ä¸‹ã€‚æ˜¯å¦è¦ä¼  intensity æœ‰å¾…ç ”ç©¶ã€‚</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">#[repr(C, align(16))]
#[derive(Debug, Clone, Copy)]
pub struct LightUniform {
    pub direction: [f32; 3],
    pub padding1: f32,
    pub color: [f32; 4],
    pub intensity: f32,
    pub padding2: [f32; 3],
}</code></pre>
            </div>
            <div class="caption"></div>
          </div>
          <p></p>
          <h1 id="heading1_6">
            <t>Engine Lifetime</t>
          </h1>
          <p>
            <t>æ¸¸æˆç›®å‰é‡‡ç”¨ä¸€å¥—ä¸´æ—¶çš„ç”Ÿå‘½å‘¨æœŸ</t>
          </p>
          <div class="code_block">
            <div class="code_part">
              <div class="code_lang">rust</div>
              <pre><code class="language-rust">input()

handle_redraw()
  pre_update() // æ›´æ–° Time
  update() //æ¸¸æˆé€»è¾‘
  post_update() // æ›´æ–° Unifoms to GPU
  render() // æ¸²æŸ“</code></pre>
            </div>
            <div class="caption">
              <t>è‡ªä¸Šè€Œä¸‹æŒ‰æ‰§è¡Œå…ˆåé¡ºåºæ’åºï¼Œç¼©è¿›ä»£è¡¨å‡½æ•°åŒ…å«å…³ç³»</t>
            </div>
          </div>
          <h1 id="heading1_7">
            <t>å…¶å®ƒ</t>
          </h1>
          <ul>
            <li>
              <t>ç›¸æœºçš„æ·±åº¦è´´å›¾è¢«å†™åœ¨ depth_texture ä¸­ï¼Œæœªæ¥ä¼šç”¨åˆ°ã€‚</t>
            </li>
          </ul>
          <ul>
            <li>
              <t>ä¸€ä¸ªç®€å•çš„ Input ç”¨äºè®°å½•è¾“å…¥</t>
            </li>
          </ul>
          <ul>
            <li>
              <t>ä¸€ä¸ªç®€å•çš„ Time ç”¨äºè®°å½• delta time</t>
            </li>
          </ul>
          <p></p>
          <h1 id="heading1_8">
            <t>ç›¸å…³é“¾æ¥</t>
          </h1>
          <p>
            <t>ã€Wgpu å…¥é—¨èµ„æ–™ã€‘</t>
            <t class="href" onclick="window.open('https://sotrh.github.io/learn-wgpu/')">https://sotrh.github.io/learn-wgpu/</t>
          </p>
          <p>
            <t>ã€Vulkan å…¥é—¨èµ„æ–™ã€‘</t>
            <t class="href" onclick="window.open('https://vulkan-tutorial.com/')">https://vulkan-tutorial.com/</t>
          </p>
          <p>
            <t>ã€ä»¥å¼€å‘æ¸¸æˆå¼•æ“çš„æ–¹å¼å­¦ä¹  Vulkanã€‘</t>
            <t class="href" onclick="window.open('https://vkguide.dev/')">https://vkguide.dev/</t>
          </p>
          <p>
            <t>ã€PBR ç†è®ºã€‘</t>
            <t class="href" onclick="window.open('https://learnopengl.com/PBR/Theory')">https://learnopengl.com/PBR/Theory</t>
          </p>
          <p>
            <t>ã€Bevy Engineã€‘</t>
            <t class="href" onclick="window.open('https://bevyengine.org/')">https://bevyengine.org/</t>
          </p>
          <p>
            <t>ã€Eguiã€‘</t>
            <t class="href" onclick="window.open('https://www.egui.rs/')">https://www.egui.rs/</t>
          </p>
          <p>
            <t>ã€ä½¿ç”¨æ¨¡å‹ã€‘</t>
            <t class="href" onclick="window.open('https://sketchfab.com/3d-models/mkr-lykken-91b274a40ebe46cd931235ac32ae0492')">https://sketchfab.com/3d-models/mkr-lykken-91b274a40ebe46cd931235ac32ae0492</t>
          </p>
          <p></p>
        </div>
      </div>
    </div>
  </body>
</html>
